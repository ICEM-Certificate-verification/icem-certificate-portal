@app.route('/bulk-upload', methods=['GET', 'POST'])
def bulk_upload():
    if request.method == 'POST':
        file = request.files['excel']
        if not file:
            return render_template("bulk-upload.html", message="‚ùå No file selected.")
        
        df = pd.read_excel(file)
        cert_ids = []
        links = []

        for i, row in df.iterrows():
            name = row['Name']
            prn = row['PRN']
            branch = row['Branch']
            date = str(row['Date'].date()) if hasattr(row['Date'], 'date') else str(row['Date'])
            title = row['Title']
            achievement = row['Achievement']

            cert_id = f"ICEM2025LIB{str(abs(hash(name + prn)) % 1000).zfill(3)}"
            cert_ids.append(cert_id)
            cert_link = f"https://icem-certificate-verification.github.io/certificates/{cert_id}.pdf"
            links.append(cert_link)

            # Generate QR
            qr = qrcode.make(cert_link)
            qr_path = f"{CERT_DIR}/{cert_id}_qr.png"
            qr.save(qr_path)

            # Generate PDF
            pdf = FPDF(orientation='L', unit='mm', format='A4')
            pdf.add_page()
            pdf.image("static/certificate-bg.png", x=0, y=0, w=297)

            pdf.set_font("Arial", 'B', 24)
            pdf.set_text_color(255, 215, 0)
            pdf.cell(0, 40, title, ln=True, align='C')

            pdf.set_font("Arial", '', 18)
            pdf.set_text_color(255, 255, 255)
            pdf.cell(0, 20, "This certificate is awarded to", ln=True, align='C')

            pdf.set_font("Arial", 'B', 28)
            pdf.cell(0, 20, name, ln=True, align='C')

            pdf.set_font("Arial", '', 16)
            pdf.multi_cell(0, 10, f"In recognition of {achievement}\n\nBranch: {branch} | PRN: {prn} | Date: {date}", align='C')

            pdf.image(qr_path, x=125, y=160, w=40)
            pdf.set_font("Arial", '', 12)
            pdf.set_y(-20)
            pdf.cell(0, 10, f"Verify this certificate at: {cert_link}", align='C')

            pdf_path = f"{CERT_DIR}/{cert_id}.pdf"
            pdf.output(pdf_path)

        # Update and save Excel file
        df['Certificate ID'] = cert_ids
        df['Certificate Link'] = links
        output_excel = os.path.join(CERT_DIR, "generated_certificates.xlsx")
        df.to_excel(output_excel, index=False)

        # Message with download link
        msg = f"‚úÖ {len(df)} certificates generated successfully!<br><br>"
        msg += f"üìÑ <a href='/static/certificates/generated_certificates.xlsx' target='_blank' style='color:white;'>Download Excel Report</a>"
        return render_template("bulk-upload.html", message=msg)

    return render_template("bulk-upload.html")
